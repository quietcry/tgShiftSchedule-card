blueprint:
  name: TG Schichtplan - Schichtprüfung
  description: |
    Prüft ob heute eine der ausgewählten Schichten im Schichtplan aktiv ist.
    Basierend auf der TG Schichtplan Card.
  domain: automation
  input:
    debugmode:
      name: "Debug-Modus"
      description: Aktiviert Debug-Ausgaben für die Schichtplanprüfung
      default: false
      selector:
        boolean: {}
    plan_entity:
      name: Plan-Entity (Schichtplan)
      description: Die input_text Entity, die den Schichtplan enthält
      selector:
        entity:
          domain: input_text
    shift_schedule_check_timer:
      name: "Schichtplanprüfung-Timer"
      default: '-'
      selector:
        entity:
          multiple: false
          filter:
            domain:
              - timer
    action_wenn_schicht_aktiv:
      name: Aktion wenn Schicht aktiv
      description: Aktion die ausgeführt wird, wenn heute eine der ausgewählten Schichten aktiv ist
      default: []
      selector:
        action: {}
    action_wenn_keine_schicht:
      name: Aktion wenn keine Schicht aktiv
      description: Aktion die ausgeführt wird, wenn heute keine der ausgewählten Schichten aktiv ist
      default: []
      selector:
        action: {}
variables:
    plan_entity: !input plan_entity
    nextEventTimer: !input shift_schedule_check_timer
    config_entity: "{{ plan_entity|string }}_config"
    status_entity: "{{ plan_entity|string }}_status"
    debugmode_input: !input debugmode
    observed_entities: >-
      {% set observed = [] %}
      {% set observed = observed + [plan_entity|string] %}
      {% set observed = observed + [config_entity|string] %}
      {% if nextEventTimer is defined and nextEventTimer != '' and nextEventTimer != '-' %}
        {% set observed = observed + [nextEventTimer|string] %}
      {% endif %}
      {{ observed }}



trigger:
  - platform: homeassistant
    event: start
    id: haStart
  - platform: time
    at: "00:00:00"
    id: time_trigger
  - platform: event
    event_type: state_changed
    id: statechanged
    variables:
      triggerdevice: "{{ {'id':trigger.event.data.entity_id} }}"


condition:
  - condition: or
    conditions:
      - condition: trigger
        id:
          - haStart
          - time_trigger
      - condition: and
        conditions:
          - condition: trigger
            id: statechanged
          - condition: template
            value_template: >
              {% if trigger.event is defined and trigger.event.data is defined and trigger.event.data.entity_id is defined %}
                {% set entity_id = trigger.event.data.entity_id %}
                {% if nextEventTimer is defined and nextEventTimer != '' and nextEventTimer != '-' and entity_id == nextEventTimer|string %}
                  {# Timer: Nur auslösen wenn Timer nicht 'active' ist #}
                  {{ states(nextEventTimer|string) != 'active' }}
                {% elif observed_entities is defined and observed_entities is iterable %}
                  {{ entity_id in observed_entities }}
                {% else %}
                  {{ entity_id == config_entity }}
                {% endif %}
              {% else %}
                {{ false }}
              {% endif %}

action:

# logic part
  - variables:
      triggerdevice: "{{ {'id': trigger.event.data.entity_id if trigger.event is defined and trigger.event.data is defined and trigger.event.data.entity_id is defined else ''} }}"
      config_entity_input: "{{ config_entity }}"
      config_data_raw: >
        {% set config_entity = config_entity_input|string|trim %}
        {% if config_entity and config_entity != '' %}
          {% set config_state = states(config_entity) %}
          {% if config_state is defined and config_state is not none and config_state|string != 'unknown' %}
            {{ config_state|string|trim }}
        {% else %}
          {{ '' }}
        {% endif %}
        {% else %}
          {{ '' }}
        {% endif %}
      config_data_parsed: >-
        {% set config_str = config_data_raw | string | trim %}
        {% set ns = namespace(newJsonString="", newPart="", shifts=[]) %}

        {% if config_str and config_str not in ['None', ''] and config_str | length > 0 %}
          {% set raw_parts = config_str.split('],') %}

          {% set ns.newJsonString = "" %}

          {% for part in raw_parts %}
            {% if ns.newJsonString != "" %}
              {% set ns.newJsonString = ns.newJsonString ~ "," %}
        {% endif %}

            {# Entferne ggf. restliche [ oder ] #}
            {% set clean_part = part | replace('[', '') | replace(']', '') %}
            {% set fields = clean_part.split(',') %}

            {% set ns.newPart = "" %}
            {% for field in fields %}
              {% if ns.newPart != "" %}
                {% set ns.newPart = ns.newPart ~ "," %}
        {% endif %}
              {% if field == '' %}
                {% set ns.newPart = ns.newPart ~ "null" %}
        {% else %}
                {% set ns.newPart = ns.newPart ~ '"' ~ field ~ '"'%}
        {% endif %}
            {% endfor %}

            {% set ns.newJsonString = ns.newJsonString ~ "[" ~ ns.newPart ~ "]" %}
          {% endfor %}

          {{ "[" ~ ns.newJsonString ~ "]" }}
        {% else %}
          []
        {% endif %}


      heute_jahr: "{{ now().strftime('%y')|string }}"
      heute_monat: "{{ now().strftime('%m')|string }}"
      heute_tag: "{{ now().strftime('%d')|string }}"
      aktuelle_zeit: "{{ now().strftime('%H:%M')|string }}"
      aktuelle_zeit_minuten: "{{ now().strftime('%H')|int * 60 + now().strftime('%M')|int }}"
      haupt_entity: "{{ plan_entity }}"
      alle_entities_json: >
          {% set ns = namespace(entities_array=[], plan_string="") %}
          {% set haupt_state = states(plan_entity) %}
          {% if haupt_state is defined and haupt_state is not none and haupt_state|string != 'unknown' %}
            {% set ns.plan_string = haupt_state|string %}
            {% for nummer in range(1, 1000) %}
              {% if nummer < 10 %}
                {% set suffix = '00' + nummer|string %}
              {% elif nummer < 100 %}
                {% set suffix = '0' + nummer|string %}
              {% else %}
                {% set suffix = nummer|string %}
              {% endif %}
              {% set entity_id = plan_entity + '_' + suffix %}
              {% set entity_state = states(entity_id) %}
              {% if entity_state is defined and entity_state is not none and entity_state|string != 'unknown' %}
                {% set ns.plan_string = ns.plan_string + entity_state|string %}
                {% set ns.entities_array = ns.entities_array + [{'id': entity_id, 'state': entity_state|string}] %}
              {% else %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% set ns.entities_array = [{'id': plan_entity, 'state': haupt_state|string, 'plan': ns.plan_string}] + ns.entities_array %}
          {% endif %}
          {% set json_result = ns.entities_array|to_json %}
          {% if json_result is defined and json_result is not none and json_result|string|trim != '' and json_result|string|trim != 'None' %}
            {{- json_result|string|trim -}}
          {% else %}
            []
          {% endif %}
      schichtplan: >
        {% set plan = '' %}
          {% if alle_entities_json is defined and alle_entities_json is not none %}
            {% set json_str = alle_entities_json|string|trim %}
            {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '[' and json_str|last == ']' %}
              {% set entities_data = json_str|from_json %}
              {% if entities_data is defined and entities_data is not none and entities_data is iterable and entities_data|length > 0 %}
                {% if entities_data[0] is defined and entities_data[0] is mapping and entities_data[0].plan is defined %}
                  {% set plan = entities_data[0].plan|string %}
                {% endif %}
              {% endif %}
            {% endif %}
        {% endif %}
        {{ plan }}
      aktive_schichten: >
          {% set ns = namespace(schichten_list=[]) %}
          {% if config_data_parsed is defined and config_data_parsed is not none %}
            {% set json_str = config_data_parsed|string|trim %}
            {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '[' and json_str|last == ']' %}
              {% set shifts_data = json_str|from_json %}
              {% if shifts_data is defined and shifts_data is not none and shifts_data is iterable %}
                {% for shift in shifts_data %}
                  {% if shift is defined and shift is not none and shift is iterable and shift|length >= 2 %}
                    {% set shortcut = shift[0]|string|trim if shift[0] is defined and shift[0] is not none else '' %}
                    {% set name = shift[1]|string|trim if shift[1] is defined and shift[1] is not none else '' %}
                    {% if shortcut != '' %}
                      {# Prüfe statusRelevant (Index 6): Nur Schichten mit statusRelevant = 1 berücksichtigen #}
                      {% set status_relevant = true %}
                      {% if shift|length > 6 and shift[6] is defined and shift[6] is not none %}
                        {% set status_relevant_value = shift[6] %}
                        {% if status_relevant_value == 0 or status_relevant_value == '0' or status_relevant_value == false or status_relevant_value == 'false' %}
                          {% set status_relevant = false %}
                        {% endif %}
                      {% endif %}
                      {% if status_relevant %}
                        {% set shift_obj = {'shortcut': shortcut, 'name': name} %}
                        {% if shift|length > 2 and shift[2] is defined and shift[2] is not none and shift[2]|string|trim != '' %}
                          {% set shift_obj = dict(shift_obj, **{'start1': shift[2]|string|trim}) %}
                        {% endif %}
                        {% if shift|length > 3 and shift[3] is defined and shift[3] is not none and shift[3]|string|trim != '' %}
                          {% set shift_obj = dict(shift_obj, **{'end1': shift[3]|string|trim}) %}
                        {% endif %}
                        {% if shift|length > 4 and shift[4] is defined and shift[4] is not none and shift[4]|string|trim != '' %}
                          {% set shift_obj = dict(shift_obj, **{'start2': shift[4]|string|trim}) %}
                        {% endif %}
                        {% if shift|length > 5 and shift[5] is defined and shift[5] is not none and shift[5]|string|trim != '' %}
                          {% set shift_obj = dict(shift_obj, **{'end2': shift[5]|string|trim}) %}
                        {% endif %}
                        {% set ns.schichten_list = ns.schichten_list + [shift_obj] %}
                      {% endif %}
            {% endif %}
          {% endif %}
          {% endfor %}
                {% endif %}
              {% endif %}
            {% endif %}
            {% set json_result = ns.schichten_list|to_json %}
            {% if json_result is defined and json_result is not none and json_result|string|trim != '' and json_result|string|trim != 'None' %}
              {{ json_result }}
            {% else %}
              []
          {% endif %}
      aktive_schichten_heute: >
          {% set ns = namespace(gefundene_schichten=[]) %}
          {% set monat_key = heute_jahr|string + ':' + heute_monat|string %}
          {% set monate = schichtplan.split(';') if schichtplan else [] %}
            {% set schichten_config = [] %}
            {% set json_str = aktive_schichten|string|trim %}
            {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '[' and json_str|last == ']' %}
              {% set schichten_config = json_str|from_json %}
            {% endif %}
          {% for monat in monate %}
              {% if monat and monat.startswith(monat_key + ':') %}
              {% set tage_teil = monat.split(':', 2)[2] if ':' in monat else '' %}
              {% if tage_teil %}
                {% set tage_liste = tage_teil.split(',') %}
                {% for tag_entry in tage_liste %}
                  {% if tag_entry and tag_entry.startswith(heute_tag|string) %}
                      {% set tag_schichten = tag_entry[heute_tag|string|length:] %}
                      {% if schichten_config is defined and schichten_config is not none and schichten_config is iterable %}
                        {% for schicht_config in schichten_config %}
                          {% if schicht_config is defined and schicht_config is not none and schicht_config is mapping %}
                            {% set shortcut = schicht_config.shortcut|string if schicht_config.shortcut is defined else '' %}
                            {% if shortcut != '' and shortcut|string in tag_schichten %}
                              {% set schicht_info = {'shortcut': shortcut, 'name': schicht_config.name|string if schicht_config.name is defined else ''} %}
                              {# Übernehme Zeitfenster-Informationen aus der Konfiguration, auch wenn nicht aktiv #}
                              {% if 'start1' in schicht_config and schicht_config.start1 is defined and schicht_config.start1 is not none and schicht_config.start1|string|trim != '' %}
                                {% set schicht_info = dict(schicht_info, **{'start1': schicht_config.start1|string|trim}) %}
                              {% endif %}
                              {% if 'end1' in schicht_config and schicht_config.end1 is defined and schicht_config.end1 is not none and schicht_config.end1|string|trim != '' %}
                                {% set schicht_info = dict(schicht_info, **{'end1': schicht_config.end1|string|trim}) %}
                              {% endif %}
                              {% if 'start2' in schicht_config and schicht_config.start2 is defined and schicht_config.start2 is not none and schicht_config.start2|string|trim != '' %}
                                {% set schicht_info = dict(schicht_info, **{'start2': schicht_config.start2|string|trim}) %}
                              {% endif %}
                              {% if 'end2' in schicht_config and schicht_config.end2 is defined and schicht_config.end2 is not none and schicht_config.end2|string|trim != '' %}
                                {% set schicht_info = dict(schicht_info, **{'end2': schicht_config.end2|string|trim}) %}
                              {% endif %}
                              {# Prüfe ob Zeitraum 1 aktiv ist #}
                              {% if 'start1' in schicht_info and 'end1' in schicht_info %}
                                {% set start1 = schicht_info.start1 %}
                                {% set end1 = schicht_info.end1 %}
                                {% set start1_parts = start1.split(':') %}
                                {% set end1_parts = end1.split(':') %}
                                {% if start1_parts|length == 2 and end1_parts|length == 2 %}
                                  {% set start1_minuten = start1_parts[0]|int * 60 + start1_parts[1]|int %}
                                  {% set end1_minuten = end1_parts[0]|int * 60 + end1_parts[1]|int %}
                                  {% if aktuelle_zeit_minuten|int >= start1_minuten and aktuelle_zeit_minuten|int <= end1_minuten %}
                                    {% set schicht_info = dict(schicht_info, **{'zeitfenster': 1, 'startzeit': start1, 'endzeit': end1}) %}
                                  {% endif %}
                                {% endif %}
                              {% endif %}
                              {# Prüfe ob Zeitraum 2 aktiv ist, falls Zeitraum 1 nicht aktiv ist #}
                              {% if 'zeitfenster' not in schicht_info and 'start2' in schicht_info and 'end2' in schicht_info %}
                                {% set start2 = schicht_info.start2 %}
                                {% set end2 = schicht_info.end2 %}
                                {% set start2_parts = start2.split(':') %}
                                {% set end2_parts = end2.split(':') %}
                                {% if start2_parts|length == 2 and end2_parts|length == 2 %}
                                  {% set start2_minuten = start2_parts[0]|int * 60 + start2_parts[1]|int %}
                                  {% set end2_minuten = end2_parts[0]|int * 60 + end2_parts[1]|int %}
                                  {% if aktuelle_zeit_minuten|int >= start2_minuten and aktuelle_zeit_minuten|int <= end2_minuten %}
                                    {% set schicht_info = dict(schicht_info, **{'zeitfenster': 2, 'startzeit': start2, 'endzeit': end2}) %}
                                  {% endif %}
                                {% endif %}
                              {% endif %}
                              {% set bereits_vorhanden = false %}
                              {% for vorhanden in ns.gefundene_schichten %}
                                {% if vorhanden.shortcut == schicht_info.shortcut %}
                                  {% set bereits_vorhanden = true %}
                                  {% break %}
                                {% endif %}
                              {% endfor %}
                              {% if not bereits_vorhanden %}
                                {% set ns.gefundene_schichten = ns.gefundene_schichten + [schicht_info] %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% set json_result = ns.gefundene_schichten|to_json %}
            {% if json_result is defined and json_result is not none and json_result|string|trim != '' and json_result|string|trim != 'None' %}
              {{ json_result }}
            {% else %}
              []
            {% endif %}
      relevante_schicht: >
          {% set json_str = aktive_schichten_heute|string|trim %}
          {% set ns = namespace(beste_schicht=none) %}
          {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '[' and json_str|last == ']' %}
            {% set schichten_data = json_str|from_json %}
            {% if schichten_data is defined and schichten_data is not none and schichten_data is iterable and schichten_data|length > 0 %}
              {% for schicht in schichten_data %}
                {% if schicht is defined and schicht is not none and schicht is mapping %}
                  {# Prüfe ob Zeitfenster definiert sind (auch wenn nicht aktiv) #}
                  {% set hat_zeitfenster_definiert = ('start1' in schicht and 'end1' in schicht) or ('start2' in schicht and 'end2' in schicht) %}
                  {# Prüfe ob Zeitfenster aktiv ist #}
                  {% set zeitfenster_aktiv = 'zeitfenster' in schicht and schicht.zeitfenster is defined and schicht.zeitfenster is not none %}
                  {# Nur Schichten ohne definierte Zeitfenster oder mit aktivem Zeitfenster berücksichtigen #}
                  {% if not hat_zeitfenster_definiert or zeitfenster_aktiv %}
                    {% if ns.beste_schicht is none %}
                      {% set ns.beste_schicht = schicht %}
                    {% else %}
                      {% set beste_hat_zeitfenster_aktiv = 'zeitfenster' in ns.beste_schicht and ns.beste_schicht.zeitfenster is defined and ns.beste_schicht.zeitfenster is not none %}
                      {% set beste_hat_zeitfenster_definiert = ('start1' in ns.beste_schicht and 'end1' in ns.beste_schicht) or ('start2' in ns.beste_schicht and 'end2' in ns.beste_schicht) %}
                      {% if zeitfenster_aktiv and not beste_hat_zeitfenster_aktiv %}
                        {# Aktives Zeitfenster schlägt kein aktives Zeitfenster #}
                        {% set ns.beste_schicht = schicht %}
                      {% elif beste_hat_zeitfenster_aktiv and not zeitfenster_aktiv %}
                        {# Beste hat aktives Zeitfenster, aktuelle nicht: beste bleibt #}
                      {% elif zeitfenster_aktiv == beste_hat_zeitfenster_aktiv %}
                        {% if zeitfenster_aktiv %}
                          {# Beide haben aktive Zeitfenster: Startzeit näher an jetzt gewinnt #}
                          {% set beste_startzeit = ns.beste_schicht.startzeit|string if 'startzeit' in ns.beste_schicht and ns.beste_schicht.startzeit is defined else '' %}
                          {% set aktuelle_startzeit = schicht.startzeit|string if 'startzeit' in schicht and schicht.startzeit is defined else '' %}
                          {% if beste_startzeit != '' and aktuelle_startzeit != '' %}
                            {# Konvertiere Zeiten zu Minuten für Vergleich #}
                            {% set beste_zeit_parts = beste_startzeit.split(':') %}
                            {% set aktuelle_zeit_parts = aktuelle_startzeit.split(':') %}
                            {% if beste_zeit_parts|length == 2 and aktuelle_zeit_parts|length == 2 %}
                              {% set beste_minuten = beste_zeit_parts[0]|int * 60 + beste_zeit_parts[1]|int %}
                              {% set aktuelle_minuten = aktuelle_zeit_parts[0]|int * 60 + aktuelle_zeit_parts[1]|int %}
                              {% set jetzt_minuten = aktuelle_zeit_minuten|int %}
                              {% set beste_diff = (jetzt_minuten - beste_minuten)|abs %}
                              {% set aktuelle_diff = (jetzt_minuten - aktuelle_minuten)|abs %}
                              {% if aktuelle_diff < beste_diff %}
                                {% set ns.beste_schicht = schicht %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                      {% else %}
                          {# Beide haben kein aktives Zeitfenster (aber auch keine definierten): erste gewinnt (bereits gesetzt) #}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
          {% if ns.beste_schicht is not none %}
            {{ ns.beste_schicht|to_json }}
          {% else %}
            {}
          {% endif %}
      schicht_aktiv: >
          {% set json_str = relevante_schicht|string|trim %}
          {% if json_str != '' and json_str != 'None' and json_str != '{}' and json_str|length > 2 %}
            {{ true }}
          {% else %}
              {{ false }}
          {% endif %}
      result: >
        {% set ergebnis = {} %}
          {% set json_str = relevante_schicht|string|trim %}
          {% if json_str != '' and json_str != 'None' and json_str != '{}' and json_str|length > 2 and json_str|first == '{' and json_str|last == '}' %}
            {% set schicht_info = json_str|from_json %}
            {% if schicht_info is defined and schicht_info is not none and schicht_info is mapping %}
              {% set shortcut = schicht_info.shortcut|string if schicht_info.shortcut is defined else '' %}
              {% if shortcut != '' and 'zeitfenster' in schicht_info and schicht_info.zeitfenster is defined and schicht_info.zeitfenster is not none %}
                {% set schicht_ergebnis_obj = {'startzeit': schicht_info.startzeit|string if schicht_info.startzeit is defined else '', 'endzeit': schicht_info.endzeit|string if schicht_info.endzeit is defined else '', 'name': schicht_info.name|string if schicht_info.name is defined else '', 'zeitfenster': schicht_info.zeitfenster|string if schicht_info.zeitfenster is defined else ''} %}
                {% set ergebnis = dict(ergebnis, **{shortcut: [schicht_ergebnis_obj]}) %}
              {% endif %}
            {% endif %}
          {% endif %}
          {{ ergebnis }}
      planned_timer: >-
        {%- macro sekunden_zu_hhmmss(sekunden) -%}
          {%- set hours = sekunden // 3600 -%}
          {%- set minutes = (sekunden % 3600) // 60 -%}
          {%- set seconds = sekunden % 60 -%}
          {%- if hours < 10 -%}
            {%- set hours_str = '0' ~ hours|string -%}
          {%- else -%}
            {%- set hours_str = hours|string -%}
          {%- endif -%}
          {%- if minutes < 10 -%}
            {%- set minutes_str = '0' ~ minutes|string -%}
          {%- else -%}
            {%- set minutes_str = minutes|string -%}
          {%- endif -%}
          {%- if seconds < 10 -%}
            {%- set seconds_str = '0' ~ seconds|string -%}
          {%- else -%}
            {%- set seconds_str = seconds|string -%}
          {%- endif -%}
          {{- hours_str ~ ':' ~ minutes_str ~ ':' ~ seconds_str -}}
        {%- endmacro -%}

        {% set timer_result = {'entity': 'none', 'nextCheck': '', 'durationTillCheck': 0, 'duration': ''} %}

        {# Setze entity, falls Timer definiert ist #}
        {% if nextEventTimer is defined and nextEventTimer != '' and nextEventTimer != '-' %}
          {% set timer_result = dict(timer_result, **{'entity': nextEventTimer|string}) %}
        {% endif %}

        {# Finde nächsten Zeitpunkt (unabhängig von Timer-Entity) #}
        {% set json_str = aktive_schichten_heute|string|trim %}
        {% set ns = namespace(naechster_check=none, naechster_duration=none) %}
        {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '[' and json_str|last == ']' %}
          {% set schichten_data = json_str|from_json %}
          {% if schichten_data is defined and schichten_data is not none and schichten_data is iterable %}
            {% for schicht in schichten_data %}
              {% if schicht is defined and schicht is not none and schicht is mapping %}
                {# Sammle alle Zeitpunkte dieser Schicht (Zeitfenster sind bereits in aktive_schichten_heute enthalten) #}
                {% for key in ['start1', 'end1', 'start2', 'end2'] %}
                  {% if key in schicht and schicht[key] is defined and schicht[key] is not none and schicht[key]|string|trim != '' %}
                    {% set zeit = schicht[key]|string|trim %}
                    {% set zeit_parts = zeit.split(':') %}
                    {% if zeit_parts|length == 2 %}
                      {% set zeit_minuten = zeit_parts[0]|int * 60 + zeit_parts[1]|int %}
                      {% if zeit_minuten > aktuelle_zeit_minuten|int and ( ns.naechster_check is none or ns.naechster_check > zeit_minuten) %}
                        {% set ns.naechster_check = zeit_minuten %}
                        {% set ns.naechster_duration = zeit_minuten - aktuelle_zeit_minuten|int %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}


        {# Berechne nextCheck und duration (unabhängig von Timer-Entity) #}
        {% set ns.next_check_str = '' %}
        {% set ns.duration = '' %}
        {% set ns.durationTillCheck = 0 %}

        {% if ns.naechster_check is not none and ns.naechster_check > 0 %}
          {# Konvertiere Minuten zu Sekunden (inkl. 5 Sekunden) für nextCheck #}
          {% set naechster_check_sekunden = ns.naechster_check * 60 + 5 %}
          {% set ns.next_check_str = sekunden_zu_hhmmss(naechster_check_sekunden)|string %}
        {% endif %}

        {% if ns.naechster_duration is not none and ns.naechster_duration > 0 %}
          {# Berechne Differenz in Sekunden (inkl. 5 Sekunden) #}
          {% set diff_sekunden = ns.naechster_duration * 60 + 5 %}
          {% set ns.durationTillCheck = diff_sekunden %}
          {% set ns.duration = sekunden_zu_hhmmss(diff_sekunden)|string %}
        {% endif %}

        {% set timer_result = dict(timer_result, **{'nextCheck': ns.next_check_str, 'durationTillCheck': ns.durationTillCheck, 'duration': ns.duration}) %}
        {{ timer_result|to_json }}

      status_text: >-
        {% set status_text_early = "1" %} {# früh oder spät #}
        {% set status_text_late = "2" %} {# früh oder spät #}
        {% set json_str = relevante_schicht|string|trim %}
        {% set status_value = '' %}
        {% if json_str != '' and json_str != 'None' and json_str != '{}' and json_str|length > 2 and json_str|first == '{' and json_str|last == '}' %}
          {% set schicht_info = json_str|from_json %}
          {% if schicht_info is defined and schicht_info is not none and schicht_info is mapping %}
            {% set schicht_name = schicht_info.name|string if 'name' in schicht_info and schicht_info.name is defined and schicht_info.name is not none else '' %}
            {% if schicht_name != '' %}
              {# Prüfe ob Zeitfenster aktiv ist #}
              {% set zeitfenster_aktiv = 'zeitfenster' in schicht_info and schicht_info.zeitfenster is defined and schicht_info.zeitfenster is not none %}
              {# Prüfe ob Zeitfenster definiert sind (auch wenn nicht aktiv) #}
              {% set hat_zeitfenster_definiert = ('start1' in schicht_info and 'end1' in schicht_info) or ('start2' in schicht_info and 'end2' in schicht_info) %}
              {% if zeitfenster_aktiv %}
                {# Zeitfenster ist aktiv, füge "früh" oder "spät" hinzu #}
                {% set status_value = schicht_name %}
                {% set zeitfenster_num = schicht_info.zeitfenster|string|trim %}
                {% if zeitfenster_num == '1' %}
                  {% set status_value = status_value ~ ' ' ~ status_text_early %}
                {% elif zeitfenster_num == '2' %}
                  {% set status_value = status_value ~ ' ' ~ status_text_late %}
                {% endif %}
              {% elif not hat_zeitfenster_definiert %}
                {# Keine Zeitfenster definiert = ganzer Tag aktiv (00:00-24:00) #}
                {% set status_value = schicht_name %}
              {% else %}
                {# Zeitfenster definiert, aber nicht aktiv = leerer Status #}
                {% set status_value = '' %}
              {% endif %}
              {# Normalisierung: Leerzeichen zu _, weitere Zeichen normalisieren #}
              {% if status_value != '' %}
                {% set status_value = status_value|replace(' ', '_')|replace('-', '_')|replace('ä', 'ae')|replace('ö', 'oe')|replace('ü', 'ue')|replace('Ä', 'Ae')|replace('Ö', 'Oe')|replace('Ü', 'Ue')|replace('ß', 'ss')|lower %}
            {% endif %}
            {% endif %}
          {% endif %}
          {% endif %}
        {{ status_value }}

# debug part
  - if:
      - condition: template
        value_template: "{{ debugmode_input }}"
    then:
      - variables:
          debugMsg: >-
            {%- macro dumpToHTML(val, filter=[], maxSteps=3, testJson=false, details=0, thisStep=0) -%}
              {%- set patternMap = '^[\s]*\{[\S\s]*\}[\s]*$' -%}
              {%- set patternList = '^[\s]*\[[\S\s]*\][\s]*$' -%}

              {%- set dump = namespace() -%}
              {%- set dump.tmp="" -%}
              {%- set dump.val=val -%}
              {%- set dump.valType=none -%}
              {%- set myFilter=filter -%}
              {%- set filter=[] -%}
              {%- set thisStep=thisStep + 1 -%}

              {%- if thisStep > maxSteps -%}
                {%- if dump.val is list or dump.val is mapping -%} {%- set dump.tmp = dump.val|to_json -%} {%- else -%} {%- set dump.tmp = dump.val -%} {%- endif -%}
                {%- set dump.valType="json" -%}
              {%- else -%}
                {%- if dump.val is string and testJson == true and ( dump.val is search(patternMap) or dump.val is search(patternList) )-%}
                  {%- set json_test = dump.val|replace("'", '"')|trim -%}
                  {%- if json_test|first == '[' or json_test|first == '{' -%}
                    {%- set dump.val=json_test|from_json -%}
                  {%- endif -%}
                {%- endif -%}
                {%- if dump.val is list -%}
                  {%- set dump.valType="list" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%}
                  {%- for item in dump.val -%}
                    {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                    {%- set dump.tmp = dump.tmp ~ "<li>" ~ myDump[1] ~ "</li>" -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%}
                {%- elif dump.val is mapping -%}
                  {%- set dump.valType="dict" -%}
                  {%- set dump.tmp = dump.tmp ~ "<ul>" -%}
                  {%- for name, item in dump.val.items() -%}
                    {%- if thisStep > 1 or name not in myFilter -%}
                      {%- set preTxt = "<li>" -%}
                      {%- set postTxt = "</li>" -%}
                      {%- set nameTxtStart = "<b>" -%}
                      {%- set NameTxtEnd = "</b>" -%}
                      {%- set myDump = dumpToHTML(item, filter, maxSteps, testJson, details, thisStep)|from_json -%}
                      {%- if details == thisStep and myDump[0] == "dict" -%}
                        {%- set preTxt = preTxt ~ "<details>" -%}
                        {%- set postTxt = "</details>" ~ postTxt -%}
                        {%- set nameTxtStart = "<summary>" ~ nameTxtStart -%}
                        {%- set NameTxtEnd = NameTxtEnd ~ "</summary>" -%}
                      {%- endif -%}

                      {%- set dump.tmp = dump.tmp ~ preTxt ~ nameTxtStart ~ name ~ ": " ~ NameTxtEnd ~ myDump[1] ~ postTxt -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set dump.tmp = dump.tmp ~ "</ul>" -%}
                {%- elif dump.val is string or dump.val is number -%}
                  {%- set dump.tmp = dump.tmp ~ " " ~ dump.val ~ "" -%}
                  {%- set dump.valType="string" -%}
                {%- endif -%}
              {%- endif -%}

              {%- if thisStep == 1 -%}
                {{- dump.tmp -}}
              {%- else -%}
                {{- [dump.valType, dump.tmp]|to_json -}}
              {%- endif -%}
            {%- endmacro -%}

            {%- set debug_obj = {} %}
            {%- set debug_obj = dict(debug_obj, **{'Heute': heute_tag ~ '.' ~ heute_monat ~ '.' ~ heute_jahr ~ ' (' ~ aktuelle_zeit ~ ')'}) %}
            {%- set debug_obj = dict(debug_obj, **{'Config-Entity': config_entity_input|string if config_entity_input is defined else '(nicht gesetzt)'}) %}
            {%- set debug_obj = dict(debug_obj, **{'Config-Daten (geparst)': (config_data_parsed|string|truncate(300) if config_data_parsed is defined and config_data_parsed|string|trim != '' else '(leer)')}) %}
            {%- set debug_obj = dict(debug_obj, **{'Alle Plan-Entities': alle_entities_json}) %}
            {%- set debug_obj = dict(debug_obj, **{'Schichtplan (Länge)': (schichtplan|length if schichtplan else 0)|string ~ ' Zeichen'}) %}
            {%- set debug_obj = dict(debug_obj, **{'Schichtplan (Inhalt)': (schichtplan|string|truncate(200) if schichtplan and schichtplan|string|trim != '' else '(leer)')}) %}

            {%- set debug_obj = dict(debug_obj, **{'Monat-Key (gesucht)': heute_jahr ~ ':' ~ heute_monat}) %}
            {%- set debug_obj = dict(debug_obj, **{'Timer': planned_timer}) %}
            {%- set debug_obj = dict(debug_obj, **{'Aktive Schichten (konfiguriert)': aktive_schichten}) %}
            {%- set debug_obj = dict(debug_obj, **{'Aktive Schichten (heute)': aktive_schichten_heute}) %}
            {%- set debug_obj = dict(debug_obj, **{'Relevante Schicht': relevante_schicht}) %}
            {%- set debug_obj = dict(debug_obj, **{'Schicht aktiv': ('Ja' if schicht_aktiv else 'Nein')}) %}
            {%- if result is defined and result is not none %}
              {%- set debug_obj = dict(debug_obj, **{'Result': result}) %}
            {%- else %}
              {%- set debug_obj = dict(debug_obj, **{'Result': {}}) %}
            {%- endif %}
            <b>Schichtplan Debug-Informationen:</b><br>
            {#
            #}
            {{- dumpToHTML(debug_obj, [], 5, true, 3) -}}
            <br><b>Trigger:</b><ul><li>{%- if "id" in trigger %}{{ trigger["id"] }}{%- endif %} [<i>{%- if "entity_id" in trigger %}{{ trigger["entity_id"] }}{%- else %}{{ trigger }}{%- endif %}</i>]</li></ul>
      - action: notify.persistent_notification
        metadata: {}
        data:
          title: "Debug TG Schichtplan"
          message: "{{- debugMsg -}}"
# action part
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ schicht_aktiv }}"
        sequence: !input action_wenn_schicht_aktiv
      - conditions:
          - condition: template
            value_template: "{{ not schicht_aktiv }}"
        sequence: !input action_wenn_keine_schicht
  - if:
      - condition: template
        value_template: "{{ status_entity is defined and status_entity != '' }}"
    then:
      - action: input_text.set_value
        metadata: {}
        data:
          value: "{{ status_text }}"
        target:
          entity_id: "{{ status_entity }}"
  - if:
      - condition: and
        conditions:
          - condition: template
            value_template: >
              {% set json_str = planned_timer|string|trim %}
              {% set result = "false" %}
              {% if json_str != '' and json_str != 'None' and json_str|length >= 2 and json_str|first == '{' and json_str|last == '}' %}
                {% set timer_data = json_str|from_json %}
                {% if timer_data is defined and timer_data is not none and timer_data is mapping %}
                  {% if timer_data.entity is defined and timer_data.entity != 'none' and timer_data.duration is defined and timer_data.duration != "" %}
                    {% set result = "true" %}
                  {% endif %}
                {% endif %}
              {% endif %}
              {{- result -}}
    then:
      - action: timer.cancel
        metadata: {}
        target:
          entity_id: >-
            {% set timer_data = planned_timer|string|trim|from_json %}
            {{- timer_data.entity -}}
      - action: timer.start
        metadata: {}
        data:
          duration: >-
            {% set timer_data = planned_timer|string|trim|from_json %}
            {{- timer_data.duration -}}
        target:
          entity_id: >-
            {% set timer_data = planned_timer|string|trim|from_json %}
            {{- timer_data.entity -}}
