blueprint:
  name: TG Schichtplan - Schichtprüfung
  description: |
    Prüft ob heute eine der ausgewählten Schichten im Schichtplan aktiv ist.
    Basierend auf der TG Schichtplan Card.
  domain: automation
  input:
    text_entity:
      name: Text-Entity (Schichtplan)
      description: Die input_text Entity, die den Schichtplan enthält
      selector:
        entity:
          domain: input_text
    schicht_a:
      name: Standardschicht (a) prüfen
      description: Prüfe ob die Standardschicht (a) aktiv ist
      default: true
      selector:
        boolean: {}
    schicht_a_startzeit:
      name: Standardschicht (a) Startzeit
      description: Optionale Startzeit für Schicht a (Format: HH:MM, z.B. 08:00)
      default: ""
      selector:
        text: {}
    schicht_a_endzeit:
      name: Standardschicht (a) Endzeit
      description: Optionale Endzeit für Schicht a (Format: HH:MM, z.B. 16:00)
      default: ""
      selector:
        text: {}
    schicht_a_text:
      name: Standardschicht (a) Text
      description: Optionaler Text für Schicht a
      default: ""
      selector:
        text: {}
    schicht_b:
      name: Schicht B prüfen
      description: Prüfe ob Schicht B aktiv ist
      default: false
      selector:
        boolean: {}
    schicht_b_startzeit:
      name: Schicht B Startzeit
      description: Optionale Startzeit für Schicht b (Format: HH:MM, z.B. 08:00)
      default: ""
      selector:
        text: {}
    schicht_b_endzeit:
      name: Schicht B Endzeit
      description: Optionale Endzeit für Schicht b (Format: HH:MM, z.B. 16:00)
      default: ""
      selector:
        text: {}
    schicht_b_text:
      name: Schicht B Text
      description: Optionaler Text für Schicht b
      default: ""
      selector:
        text: {}
    schicht_c:
      name: Schicht C prüfen
      description: Prüfe ob Schicht C aktiv ist
      default: false
      selector:
        boolean: {}
    schicht_c_startzeit:
      name: Schicht C Startzeit
      description: Optionale Startzeit für Schicht c (Format: HH:MM, z.B. 08:00)
      default: ""
      selector:
        text: {}
    schicht_c_endzeit:
      name: Schicht C Endzeit
      description: Optionale Endzeit für Schicht c (Format: HH:MM, z.B. 16:00)
      default: ""
      selector:
        text: {}
    schicht_c_text:
      name: Schicht C Text
      description: Optionaler Text für Schicht c
      default: ""
      selector:
        text: {}
    schicht_d:
      name: Schicht D prüfen
      description: Prüfe ob Schicht D aktiv ist
      default: false
      selector:
        boolean: {}
    schicht_d_startzeit:
      name: Schicht D Startzeit
      description: Optionale Startzeit für Schicht d (Format: HH:MM, z.B. 08:00)
      default: ""
      selector:
        text: {}
    schicht_d_endzeit:
      name: Schicht D Endzeit
      description: Optionale Endzeit für Schicht d (Format: HH:MM, z.B. 16:00)
      default: ""
      selector:
        text: {}
    schicht_d_text:
      name: Schicht D Text
      description: Optionaler Text für Schicht d
      default: ""
      selector:
        text: {}
    schicht_e:
      name: Schicht E prüfen
      description: Prüfe ob Schicht E aktiv ist
      default: false
      selector:
        boolean: {}
    schicht_e_startzeit:
      name: Schicht E Startzeit
      description: Optionale Startzeit für Schicht e (Format: HH:MM, z.B. 08:00)
      default: ""
      selector:
        text: {}
    schicht_e_endzeit:
      name: Schicht E Endzeit
      description: Optionale Endzeit für Schicht e (Format: HH:MM, z.B. 16:00)
      default: ""
      selector:
        text: {}
    schicht_e_text:
      name: Schicht E Text
      description: Optionaler Text für Schicht e
      default: ""
      selector:
        text: {}
    action_wenn_schicht_aktiv:
      name: Aktion wenn Schicht aktiv
      description: Aktion die ausgeführt wird, wenn heute eine der ausgewählten Schichten aktiv ist
      default: []
      selector:
        action: {}
    action_wenn_keine_schicht:
      name: Aktion wenn keine Schicht aktiv
      description: Aktion die ausgeführt wird, wenn heute keine der ausgewählten Schichten aktiv ist
      default: []
      selector:
        action: {}

trigger:
  - platform: homeassistant
    event: start
    id: haStart
  - platform: time
    at: "00:00:00"
  - platform: state
    entity_id: !input text_entity

condition: []

action:
  - variables:
      text_entity_input: !input text_entity
      schicht_a_input: !input schicht_a
      schicht_b_input: !input schicht_b
      schicht_c_input: !input schicht_c
      schicht_d_input: !input schicht_d
      schicht_e_input: !input schicht_e
      schicht_a_startzeit_input: !input schicht_a_startzeit
      schicht_a_endzeit_input: !input schicht_a_endzeit
      schicht_a_text_input: !input schicht_a_text
      schicht_b_startzeit_input: !input schicht_b_startzeit
      schicht_b_endzeit_input: !input schicht_b_endzeit
      schicht_b_text_input: !input schicht_b_text
      schicht_c_startzeit_input: !input schicht_c_startzeit
      schicht_c_endzeit_input: !input schicht_c_endzeit
      schicht_c_text_input: !input schicht_c_text
      schicht_d_startzeit_input: !input schicht_d_startzeit
      schicht_d_endzeit_input: !input schicht_d_endzeit
      schicht_d_text_input: !input schicht_d_text
      schicht_e_startzeit_input: !input schicht_e_startzeit
      schicht_e_endzeit_input: !input schicht_e_endzeit
      schicht_e_text_input: !input schicht_e_text
      heute_jahr: "{{ now().strftime('%y') }}"
      heute_monat: "{{ now().strftime('%m') }}"
      heute_tag: "{{ now().strftime('%d') }}"
      aktuelle_zeit: "{{ now().strftime('%H:%M') }}"
      haupt_entity: "{{ text_entity_input }}"
      zusaetzliche_entities: >
        {% set base_entity = text_entity_input %}
        {% set entity_parts = base_entity.split('.') %}
        {% set zusatz = [] %}
        {% if entity_parts|length == 2 %}
          {% set domain = entity_parts[0] %}
          {% set base_name = entity_parts[1] %}
          {% for nummer in range(1, 1000) %}
            {% if nummer < 10 %}
              {% set suffix = '00' + nummer|string %}
            {% elif nummer < 100 %}
              {% set suffix = '0' + nummer|string %}
            {% else %}
              {% set suffix = nummer|string %}
            {% endif %}
            {% set entity_id = domain + '.' + base_name + '_' + suffix %}
            {% if states(entity_id) is defined and states(entity_id) is not none %}
              {% set _ = zusatz.append(entity_id) %}
            {% else %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ zusatz }}
      alle_entities: >
        {% set alle = [haupt_entity] %}
        {% for entity in zusaetzliche_entities %}
          {% set _ = alle.append(entity) %}
        {% endfor %}
        {{ alle }}
      schichtplan: >
        {% set teile = [] %}
        {% for entity_id in alle_entities %}
          {% set entity_state = states(entity_id) %}
          {% if entity_state and entity_state|string|trim != '' %}
            {% set _ = teile.append(entity_state|string) %}
          {% endif %}
        {% endfor %}
        {{ teile|join(';') }}
      aktive_schichten: >
        {% set schichten = [] %}
        {% if schicht_a_input %}{% set _ = schichten.append('a') %}{% endif %}
        {% if schicht_b_input %}{% set _ = schichten.append('b') %}{% endif %}
        {% if schicht_c_input %}{% set _ = schichten.append('c') %}{% endif %}
        {% if schicht_d_input %}{% set _ = schichten.append('d') %}{% endif %}
        {% if schicht_e_input %}{% set _ = schichten.append('e') %}{% endif %}
        {{ schichten }}
      aktive_schichten_heute: >
        {% set monat_key = heute_jahr + ':' + heute_monat %}
        {% set monate = schichtplan.split(';') if schichtplan else [] %}
        {% set gefundene_schichten = [] %}
        {% for monat in monate %}
          {% if monat and monat.startswith(monat_key + ':') %}
            {% set tage_teil = monat.split(':', 2)[2] if ':' in monat else '' %}
            {% if tage_teil %}
              {% set tage_liste = tage_teil.split(',') %}
              {% for tag_entry in tage_liste %}
                {% if tag_entry and tag_entry.startswith(heute_tag) %}
                  {% for schicht in aktive_schichten %}
                    {% if schicht in tag_entry and schicht not in gefundene_schichten %}
                      {% set _ = gefundene_schichten.append(schicht) %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ gefundene_schichten }}
      schicht_aktiv: "{{ aktive_schichten_heute|length > 0 }}"
      result: >
        {% set ergebnis = [] %}
        {% for schicht in aktive_schichten_heute %}
          {% if schicht == 'a' and schicht_a_startzeit_input|trim != '' and schicht_a_endzeit_input|trim != '' %}
            {% if aktuelle_zeit >= schicht_a_startzeit_input and aktuelle_zeit <= schicht_a_endzeit_input %}
              {% set _ = ergebnis.append({'startzeit': schicht_a_startzeit_input, 'endzeit': schicht_a_endzeit_input, 'text': schicht_a_text_input}) %}
            {% endif %}
          {% elif schicht == 'b' and schicht_b_startzeit_input|trim != '' and schicht_b_endzeit_input|trim != '' %}
            {% if aktuelle_zeit >= schicht_b_startzeit_input and aktuelle_zeit <= schicht_b_endzeit_input %}
              {% set _ = ergebnis.append({'startzeit': schicht_b_startzeit_input, 'endzeit': schicht_b_endzeit_input, 'text': schicht_b_text_input}) %}
            {% endif %}
          {% elif schicht == 'c' and schicht_c_startzeit_input|trim != '' and schicht_c_endzeit_input|trim != '' %}
            {% if aktuelle_zeit >= schicht_c_startzeit_input and aktuelle_zeit <= schicht_c_endzeit_input %}
              {% set _ = ergebnis.append({'startzeit': schicht_c_startzeit_input, 'endzeit': schicht_c_endzeit_input, 'text': schicht_c_text_input}) %}
            {% endif %}
          {% elif schicht == 'd' and schicht_d_startzeit_input|trim != '' and schicht_d_endzeit_input|trim != '' %}
            {% if aktuelle_zeit >= schicht_d_startzeit_input and aktuelle_zeit <= schicht_d_endzeit_input %}
              {% set _ = ergebnis.append({'startzeit': schicht_d_startzeit_input, 'endzeit': schicht_d_endzeit_input, 'text': schicht_d_text_input}) %}
            {% endif %}
          {% elif schicht == 'e' and schicht_e_startzeit_input|trim != '' and schicht_e_endzeit_input|trim != '' %}
            {% if aktuelle_zeit >= schicht_e_startzeit_input and aktuelle_zeit <= schicht_e_endzeit_input %}
              {% set _ = ergebnis.append({'startzeit': schicht_e_startzeit_input, 'endzeit': schicht_e_endzeit_input, 'text': schicht_e_text_input}) %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ergebnis }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ schicht_aktiv }}"
        sequence: !input action_wenn_schicht_aktiv
      - conditions:
          - condition: template
            value_template: "{{ not schicht_aktiv }}"
        sequence: !input action_wenn_keine_schicht


